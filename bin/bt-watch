#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt/em_cli'
require 'trollop'

include BT::Cli

opts = Trollop::options do
  banner <<-EOS
Watch a repository for stages to build

Usage:
\tbt-watch [repository]
  EOS
end

repository = ARGV.shift || Dir.pwd

EM.run {
  Signal.trap('INT') { EM.stop }

  local = LocalRepository.new(repository)

  local.synchronised do |path|
    ready = Ready.new(path) do |commit, stage|
      agent = Agent.new "#{commit}/#{stage}"
      go = Go.new path, commit, stage

      agent.leading { go.build }

      go.started { |commit, stage| puts "#{commit}/#{stage}: START" }

      agent.stopped do
        go.stop
        local.sync
      end

      go.line { |line| puts line }

      go.done do
        puts "#{commit}/#{stage}: DONE"
        agent.stop
      end
    end

    ready.none { EM.add_timer(2, proc { local.sync }) }

    ready.next
  end

  local.sync
}

