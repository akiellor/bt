#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt'
require 'yaml'

opts = Trollop::options do
  banner <<-EOS
  Shows canonical stage definition for commit.

Usage: bt-stages [OPTS...] [DIRECTORY]
  EOS

  opt :commit, 'Commit to generate stage definition from', :default => 'HEAD'
end

directory = ARGV.shift || Dir.pwd

BT::Repository.mirror(directory) do |r|
  r.working_tree :commit => opts[:commit] do |t|
    specification = {}
    stage_dir = File.join(Dir.pwd, 'stages')

    Dir.glob(File.join(stage_dir, '*')).each do |filename|
      if File.executable?(filename)
        specification.merge!(YAML.load(`#{filename}`))
      else
        yaml = YAML.load(File.open(filename).read)
        specification.merge!({File.basename(filename) => {'needs' => [], 'results' => [], 'run' => ''}.merge(yaml)})
      end
    end

    y specification
  end
end
