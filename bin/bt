#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt'
require 'grit'
require 'trollop'

module BT
  COMMANDS = %w(ready go watch)
  global_opts = Trollop::options do
    opt :debug, "Debugging text scrolls"
    banner <<-EOS
build thing

Usage:
\tbt [command] ...
Commands:
\t#{COMMANDS.join "\n\t"}
    EOS
    stop_on COMMANDS
  end


  command = ARGV.shift
  command_opts = case command
                 when 'ready'
                   single_repo_cmd(command, 'List of stages ready to go') do |r|
                     r.head.pipeline.ready.each { |s| puts s.name }
                   end

                 when 'go'
                   single_repo_cmd(command, 'Build a ready stage') do |r|
                     if stage = r.head.pipeline.ready.first
                       stage.build
                     else
                       Trollop::die "no stage to build"
                     end
                   end

                 when 'watch'
                   opts = Trollop::options do
                     banner <<-EOS
Watch and build stages ready to go on a repository

Usage:
\tbt watch [repository]
EOS
                     opt :wait, 'time to wait between builds', :type => :int, :default => 5
                   end

                   Repository::bare(ARGV.shift || Dir.pwd) do |r|
                     while true
                       r.update
                       r.head.pipeline.go
                       sleep opts[:wait]
                     end
                   end
                 when nil
                   Trollop::die "need a command"

                 else
                   Trollop::die "unknown command #{command.inspect}"

                 end
end
