#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'trollop'
require 'bt'

module BT
  COMMANDS = %w(ready go watch)
  global_opts = Trollop::options do
    banner 'build thing'
    # TODO: Help on which commands are available.
    opt :repository, 'git repository', :type => :string, :default => Dir.pwd
    stop_on COMMANDS
  end

  repo = Repository.new global_opts.repository

  command = ARGV.shift
  command_opts = case command
                 when 'ready'
                   repo.ready.each { |s| puts s.name }
                 when 'go'
                   stage = repo.ready.first
                   Trollop::die "no stage to build" unless stage

                   stage.build
                 when 'watch'
                   repo.bare do |b|
                     while true
                       b.pull

                       b.ready.first.lead do |stage|
                         b.push if stage.build
                       end

                       sleep 5
                     end
                   end
                 when nil
                   Trollop::die "need a command"
                 else
                   Trollop::die "unknown command #{command.inspect}"
                 end
end
