#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt'

include BT::Cli

opts = Trollop::options do
  banner <<-EOS
Builds ready stages until there aren't any.

Usage:
\tbt go
  EOS
  opt :debug, 'Debugging text scrolls'
  opt :once, 'Build only the next ready stage'
  opt :commit, 'Build the specified commit', :default => 'HEAD'
  opt :directory, 'Change to DIRECTORY before doing anything.', :short => :c, :type => :string, :default => Dir.pwd
end

Grit.debug = true if opts[:debug]

stage_definition = YAML.load(`#{find_command :stages} --commit #{opts[:commit]} --directory #{opts[:directory]}`)

r = BT::Repository.new opts[:directory]

class Pipeline < Struct.new(:commit, :stage_definition)
  def stages
    stage_definition.map do |name, definition|
      BT::Stage.new commit, name, definition
    end
  end

  def ready
    stages.select(&:ready?)
  end
end

pipeline = Pipeline.new(r.commit(opts[:commit]), stage_definition)

while (stage = pipeline.ready.first)
  stage.build
  puts "#{stage.name}: #{stage.result}"
  break if opts[:once]
end
